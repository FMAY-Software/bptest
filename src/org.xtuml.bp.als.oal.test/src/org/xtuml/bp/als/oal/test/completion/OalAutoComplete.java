//=====================================================================
//
// NOTE: This file was generated, but is maintained by hand.
// Generated by: UnitTestGenerator.pl
// Version:      1.15
// Matrix:       oal_autocomplete_matrix.txt
//
//=====================================================================

package org.xtuml.bp.als.oal.test.completion;

import java.lang.reflect.InvocationTargetException;

import org.eclipse.jface.text.BadLocationException;
import org.eclipse.jface.text.BadPositionCategoryException;
import org.eclipse.jface.text.Document;
import org.eclipse.jface.text.IDocument;
import org.eclipse.jface.text.IRegion;
import org.eclipse.ui.IEditorPart;
import org.junit.After;
import org.junit.Before;
import org.xtuml.bp.als.oal.ParseRunnable;
import org.xtuml.bp.core.Action_c;
import org.xtuml.bp.core.Body_c;
import org.xtuml.bp.core.BridgeBody_c;
import org.xtuml.bp.core.Bridge_c;
import org.xtuml.bp.core.Component_c;
import org.xtuml.bp.core.DerivedAttributeBody_c;
import org.xtuml.bp.core.DerivedBaseAttribute_c;
import org.xtuml.bp.core.FunctionBody_c;
import org.xtuml.bp.core.Function_c;
import org.xtuml.bp.core.Ooaofooa;
import org.xtuml.bp.core.OperationBody_c;
import org.xtuml.bp.core.Operation_c;
import org.xtuml.bp.core.Package_c;
import org.xtuml.bp.core.ProposalList_c;
import org.xtuml.bp.core.Proposal_c;
import org.xtuml.bp.core.ProvidedOperationBody_c;
import org.xtuml.bp.core.ProvidedOperation_c;
import org.xtuml.bp.core.ProvidedSignalBody_c;
import org.xtuml.bp.core.ProvidedSignal_c;
import org.xtuml.bp.core.RequiredOperationBody_c;
import org.xtuml.bp.core.RequiredOperation_c;
import org.xtuml.bp.core.RequiredSignalBody_c;
import org.xtuml.bp.core.RequiredSignal_c;
import org.xtuml.bp.core.StateActionBody_c;
import org.xtuml.bp.core.TransitionActionBody_c;
import org.xtuml.bp.core.common.ClassQueryInterface_c;
import org.xtuml.bp.core.common.NonRootModelElement;
import org.xtuml.bp.core.ui.Selection;
import org.xtuml.bp.core.util.ActionLanguageDescriptionUtil;
import org.xtuml.bp.ui.canvas.test.CanvasTest;
import org.xtuml.bp.ui.text.activity.ParseAllActivitiesAction;

public class OalAutoComplete extends CanvasTest {
    public static boolean generateResults = false;
    public static boolean useDrawResults = false;
    String[] results = null;

    String test_id = "";

    protected String getResultName() {
        return getClass().getSimpleName() + "_" + test_id;
    }

    protected IEditorPart fActiveEditor;

    protected IEditorPart getActiveEditor() {
        return fActiveEditor;
    }

    public OalAutoComplete(String subTypeClassName, String subTypeArg0) {
        super(null, subTypeArg0);
    }

    protected String getTestId(String src, String dest, String count) {
        return "test_" + count;
    }

    @Before
    public void setUp() throws Exception {
        super.setUp();
    }
    
    @Override
    protected void initialSetup() throws Exception {
    	loadProject("oal_autocomplete");
    	modelRoot = Ooaofooa.getInstance("/oal_autocomplete/models/oal_autocomplete/Container/Container.xtuml");
    	// create the initial OAL instances
    	Package_c container = Package_c.getOneEP_PKGOnR1401(m_sys, new ClassQueryInterface_c() {
			
			@Override
			public boolean evaluate(Object candidate) {
				return ((Package_c) candidate).getName().equals("Container");
			}
		});
    	Selection.getInstance().clear(); Selection.getInstance().addToSelection(container);
    	ParseAllActivitiesAction action = new ParseAllActivitiesAction();
    	action.run(null);
    };

    @After
    public void tearDown() throws Exception {
        // do not tear down yet, not required as the supertype requires UI while these tests
    	// do not
    }

    /**
     * "LPAH" is one of the degrees of freedom as specified in this issues
     * test matrix.
     * This routine gets the "LPAH" instance from the given name.
     * 
     * @param element The degree of freedom instance to retrieve
     * @return A model element used in the test as specified by the test matrix
     */
    NonRootModelElement selectLPAH(String element) {
        return selectLPAH(element, null);
    }

    /**
     * "LPAH" is one of the degrees of freedom as specified in this issues
     * test matrix.
     * This routine gets the "LPAH" instance from the given name.
     * 
     * @param element The degree of freedom instance to retrieve
     * @param extraData Extra data needed for selection
     * @return A model element used in the test as specified by the test matrix
     */
    NonRootModelElement selectLPAH(String element, Object extraData) {
    	return findElementForDof(element);
    }

	private int getLineNumber(String element) {
		if(element.contains("S2")) {
			return 28;
		} else if(element.contains("S3")) {
			return 39;
		}
		return 26;
	}

	private String getLocationText() {
		if(getName().contains("L2")) {
			return "l2_var.";
		} else if(getName().contains("L3")) {
			return "::";
		} else if(getName().contains("L4")) {
			return "send";
		} else if(getName().contains("L5")) {
			return "send Port1::";
		} else if(getName().contains("L6")) {
			return "Port1::operation(parameter: 1) to";
		} else if(getName().contains("L7")) {
			return "select one l7_var_one";
		} else if(getName().contains("L8")) {
			return "select one l8_var_one related by l8_var_two->";
		} else if(getName().contains("L9")) {
			return "select one l9_var from instances of ";
		} else if(getName().contains("L10")) {
			return "generate";
		} else if(getName().contains("L11")) {
			return "generate L11Class1:event to";
		} else if(getName().contains("L12")) {
			return "p12_var =";
		} else if(getName().contains("L13")) {
			return "for each l13_var in";
		} else if(getName().contains("L14")) {
			return "return";
		} else if(getName().contains("L15")) {
			return "relate";
		} else if(getName().contains("L16")) {
			return "relate l16_var to";
		} else if(getName().contains("L17")) {
			return "relate l17_var to l17_var_2 across";
		} else if(getName().contains("L18")) {
			return "relate l18_var to l18_var_2 across R1.";
		} else if(getName().contains("L19")) {
			return "relate l19_var to l19_var_other across R2 using";
		} else if(getName().contains("L20")) {
			return "unrelate l20_var from";
		} else if(getName().contains("L21")) {
			return "unrelate l21_var from l21_var_2 across";
		} else if(getName().contains("L22")) {
			return "unrelate l22_var from l22_var_2 across R1.";
		} else if(getName().contains("L23")) {
			return "unrelate l23_var from l23_other across R2 using";
		} else if(getName().contains("L24")) {
			return "self.";
		} else if(getName().contains("L25")) {
			return "";
		} else if(getName().contains("L26")) {
			return "cardinality";
		} else if(getName().contains("L27")) {
			return "param.";
		} else if(getName().contains("L28")) {
			return "create object instance l28_var of";
		} else if(getName().contains("L29")) {
			return "delete object instance";
		} else if(getName().contains("L30")) {
			return "if(";
		} else if(getName().contains("L31")) {
			return "crete event instance l31_var of";
		} else if(getName().contains("L32")) {
			return "create event instance l32_var of L11Class1 to";
		} else if(getName().contains("L33")) {
			return "L33::";
		}
		return "";
	}
	
	private String[] getPossibilities(String element) {
		if(element.contains("P1")) {
			return new String[] {"control stop"};
		} else if (element.contains("P2")) {
			return new String[] {"create event instance"};
		} else if (element.contains("P3")) {
			return new String[] {"create object instance"};
		} else if (element.contains("P4")) {
			return new String[] {"delete object instance"};
		} else if (element.contains("P5")) {
			return new String[] {"for each"};
		} else if (element.contains("P6")) {
			return new String[] {"generate"};
		} else if (element.contains("P7")) {
			return new String[] {"if"};
		} else if (element.contains("P8")) {
			return new String[] {"param"};
		} else if (element.contains("P9")) {
			return new String[] {"relate"};
		} else if (element.contains("P10")) {
			return new String[] {"return"};
		} else if (element.contains("P11")) {
			return new String[] {"select any"};
		} else if (element.contains("P12")) {
			return new String[] {"select many"};
		} else if (element.contains("P13")) {
			return new String[] {"select one"};
		} else if (element.contains("P14")) {
			return new String[] {"send"};
		} else if (element.contains("P15")) {
			return new String[] {"unrelate"};
		} else if (element.contains("P16")) {
			return new String[] {"while"};
		} else if (element.contains("P17")) {
			return new String[] {"break"};
		} else if (element.contains("P18")) {
			return new String[] {"continue"};
		} else if (element.contains("P19")) {
			return new String[] {"end while"};
		} else if (element.contains("P20")) {
			return new String[] {"end for"};
		} else if (element.contains("P21")) {
			return new String[] {"elif"};
		} else if (element.contains("P22")) {
			return new String[] {"else"};
		} else if (element.contains("P23")) {
			return new String[] {"end if"};
		} else if (element.contains("P24")) {
			return new String[] {"self"};
		}  else if (element.contains("P25")) {
			return new String[] { "l2_var", "l8_var_one", "l8_var_two", "l11_var", "l11_inst_event", "l13_vars",
					"l16_var", "l16_var_2", "l17_var", "l17_var_2", "l18_var", "l18_var_2", "l19_var", "l19_var_other",
					"l19_var_link", "l20_var", "l20_var_2", "l21_var", "l21_var_2", "l22_var", "l22_var_2", "l23_var",
					"l23_other", "l23_link", "x" };
		} else if (element.contains("P26")) {
			return new String[] {"L33_ee"};
		} else if (element.contains("P27")) {
			return new String[] {"L33"};
		} else if (element.contains("P28")) {
			return new String[] {"Port 1", "Port 2"};
		} else if (element.contains("P29")) {
			return new String[] {"attribute", "operation( param_one: integer, param_two: integer )"};
		} else if (element.contains("P30")) {
			return new String[] {"operation( param_one: integer, param_two: integer )"};
		} else if (element.contains("P31")) {
			return new String[] {"cb_operation"};
		} else if (element.contains("P32")) {
			return new String[0]; // not tested yet
		} else if (element.contains("P33")) {
			return new String[] {"function( parameter: integer)", "FunctionOne()", "FunctionOne-Parameters( ParameterOne: integer, ParameterTwo: real, ParameterThree: unique_id )", "FunctionTwo()", "FunctionTwo-Parameters( ParameterOne: integer, ParameterTwo: real, ParameterThree: unique_id )"};
		} else if (element.contains("P34")) {
			return new String[] {""}; // not tested yet
		} else if (element.contains("P35")) {
			return new String[] {"R1"};
		} else if (element.contains("P36")) {
			return new String[] {"formalizer"};
		} else if (element.contains("P37")) {
			return new String[] {"creator"};
		} else if (element.contains("P38")) {
			return new String[] {"class"};
		} else if (element.contains("P39")) {
			return new String[] {"l11_inst_event"};
		} else if (element.contains("P40")) {
			return new String[] {"where"};
		} else if (element.contains("P41")) {
			return new String[] {"cardinality"};
		} else if (element.contains("P42")) {
			return new String[] {"empty"};
		} else if (element.contains("P43")) {
			return new String[] {"not"};
		} else if (element.contains("P44")) {
			return new String[] {"param"};
		} else if (element.contains("P45")) {
			return "param";
		} else if (element.contains("P46")) {
			return new String[] {"not"};
		} else if (element.contains("P47")) {
			return new String[] {"true"};
		} else if (element.contains("P48")) {
			return new String[] {"false"};
		} /** else if (element.contains("P49")) {
			return "param";
		} else if (element.contains("P50")) {
			return "param";
		} else if (element.contains("P51")) {
			return "param";
		} else if (element.contains("P52")) {
			return "param";
		} else if (element.contains("P53")) {
			return "param";
		} else if (element.contains("P54")) {
			return "param";
		} else if (element.contains("P55")) {
			return "param";
		} else if (element.contains("P56")) {
			return "param";
		} else if (element.contains("P57")) {
			return "param";
		} else if (element.contains("P58")) {
			return "param";
		} else if (element.contains("P59")) {
			return "param";
		} */
		return new String[0];
	}

	private String[] populateAutoComplete(String element) throws BadLocationException {
		if(getName().contains("AH11")) return new String[0];
		NonRootModelElement rootElement = (NonRootModelElement) getRootElementForBody(testBody)[0];
		int lineNumber = getLineNumber(element);
		String locationText = getLocationText();
		String action = ActionLanguageDescriptionUtil.getActionLanguageAttributeValue(rootElement);
		Document doc = new Document(action);
		IRegion region = doc.getLineInformation(lineNumber);
		doc.replace(region.getOffset(), locationText.length(), locationText);
		int col = positionToCol(region.getOffset(), doc);
        ParseRunnable parseRunner = new ParseRunnable(rootElement, doc.get(),
                lineNumber - 1, col);
        parseRunner.run();
		Proposal_c[] proposals = Proposal_c.getManyP_PsOnR1601(ProposalList_c.getManyP_PLsOnR1603(testBody));
		String[] results = new String[proposals.length];
		for(int i = 0; i < results.length; i++) {
			results[i] = proposals[i].getDisplay_text();
		}
		return results;
	}

	private int positionToCol(int position, IDocument document) {
		for (int i = 0, count = 0; i < document.getNumberOfLines(); i++) {
			try {
				if (position - count <= document.getLineLength(i))
					return position - count + 1;
				count += document.getLineLength(i);
			} catch (BadLocationException e) {
				e.printStackTrace();
			}
		}
		return 0;
	}

	public static Object[] getRootElementForBody(NonRootModelElement columnInstance) {
		NonRootModelElement element = Bridge_c.getOneS_BRGOnR697(BridgeBody_c.getManyACT_BRBsOnR698((Body_c) columnInstance));
		if (element == null) {
			element = Operation_c.getOneO_TFROnR696((OperationBody_c.getManyACT_OPBsOnR698((Body_c) columnInstance)));
		}
		if(element == null) {
			element = Action_c.getOneSM_ACTOnR691(StateActionBody_c.getManyACT_SABsOnR698((Body_c) columnInstance));
		} 
		if(element == null) {
			element = Function_c.getOneS_SYNCOnR695(FunctionBody_c.getManyACT_FNBsOnR698((Body_c) columnInstance));
		} 
		if(element == null) {
			element = DerivedBaseAttribute_c.getOneO_DBATTROnR693(DerivedAttributeBody_c.getManyACT_DABsOnR698((Body_c) columnInstance));
		} 
		if(element == null) {
			element = ProvidedOperation_c.getOneSPR_POOnR687(ProvidedOperationBody_c.getManyACT_POBsOnR698((Body_c) columnInstance));
		} 
		if (element == null) {
			element = ProvidedSignal_c.getOneSPR_PSOnR686(ProvidedSignalBody_c.getManyACT_PSBsOnR698((Body_c) columnInstance));
		} 
		if (element == null) {
			element = RequiredOperation_c.getOneSPR_ROOnR685(RequiredOperationBody_c.getManyACT_ROBsOnR698((Body_c) columnInstance));
		} 
		if (element == null) {
			element = RequiredSignal_c.getOneSPR_RSOnR684(RequiredSignalBody_c.getManyACT_RSBsOnR698((Body_c) columnInstance));
		} 
		if (element == null) {
			element = Action_c.getOneSM_ACTOnR688(TransitionActionBody_c.getManyACT_TABsOnR698((Body_c) columnInstance));
		}
		String action = ActionLanguageDescriptionUtil.getActionLanguageAttributeValue(element);
		return new Object[] { element, action };
	}

	Body_c testBody = null;
	private String[] actualProposals;
	NonRootModelElement findElementForDof(String element) {
		ClassQueryInterface_c classQuery = new ClassQueryInterface_c() {

			@Override
			public boolean evaluate(Object candidate) {
				// ignore empty bodies
				Object[] detail = getBodyDetail((Body_c) candidate);
				NonRootModelElement pkg = (Package_c) detail[0];
				String action = (String) detail[1];
				if(action.length() == 0) {
					return false;
				}
				int index = getName().indexOf("AH");
				int length = getName().length();
				CharSequence testSequence = getName().subSequence(index, length);
				index = pkg.getName().indexOf("AH");
				if(index != -1) {
					length = pkg.getName().length();
					CharSequence pkgSequence = pkg.getName().subSequence(index, length);			
					return testSequence.equals(pkgSequence);
				}
				return false;
			}
		};
		testBody = Body_c.BodyInstance(modelRoot, classQuery);
		return testBody;
	}
    protected Object[] getBodyDetail(Body_c body) {
    	Object[] bodyDetail = getRootElementForBody(body);
		NonRootModelElement root = (NonRootModelElement) bodyDetail[0];
		Package_c parentPackage = root.getFirstParentPackage();
		if(parentPackage == null) {
			Component_c parentComponent = root.getFirstParentComponent();
			if(parentComponent != null) {
				parentPackage = parentComponent.getFirstParentPackage();
			}
		}
		bodyDetail[0] = parentPackage;
		return bodyDetail;
	}

	/**
     * "SV" is one of the degrees of freedom as specified in this issues
     * test matrix.
     * This routine gets the "SV" instance from the given name.
     * 
     * @param element The degree of freedom instance to retrieve
     * @return A model element used in the test as specified by the test matrix
     */
    NonRootModelElement selectSV(String element) {
        return selectSV(element, null);
    }

    /**
     * "SV" is one of the degrees of freedom as specified in this issues
     * test matrix.
     * This routine gets the "SV" instance from the given name.
     * 
     * @param element The degree of freedom instance to retrieve
     * @param extraData Extra data needed for selection
     * @return A model element used in the test as specified by the test matrix
     */
    NonRootModelElement selectSV(String element, Object extraData) {
    	// everything will be selected in the PAH selection, and test run
        return null;
    }

    /**
     * This routine performs the action associated with a matrix cell.
     * The parameters represent model instances aquired based on the specifed
     * column instance and row instance.
     * 
     * @param columnInstance Model instance from the column
     * @param rowInstance Model instance from the row
     * @throws BadPositionCategoryException 
     * @throws BadLocationException 
     * @throws InvocationTargetException 
     * @throws IllegalArgumentException 
     * @throws IllegalAccessException 
     * @throws SecurityException 
     * @throws NoSuchMethodException 
     */
    void SV_LPAH_Action(NonRootModelElement columnInstance, NonRootModelElement rowInstance) throws BadLocationException, BadPositionCategoryException, NoSuchMethodException, SecurityException, IllegalAccessException, IllegalArgumentException, InvocationTargetException {
        actualProposals = populateAutoComplete(getName());
    }

    /**
    * This function verifies an expected result.
    *
    * @param source A model element instance aquired through a action taken
    *               on a column of the matrix.
    * @param destination A model element instance aquired through a action taken
    *                    taken on a row of the matrix.
    * @return true if the test succeeds, false if it fails
    */
    boolean checkResult_non(NonRootModelElement source, NonRootModelElement destination) {
    	for(String actual : actualProposals) {
    		// make sure no possibility is present
    		for(String possibility : getPossibilities(getName())) {
	        	if(actual.equals(possibility)) {
	        		return false;
	        	}
    		}
        }
        return true;
    }


    /**
    * This function verifies an expected result.
    *
    * @param source A model element instance aquired through a action taken
    *               on a column of the matrix.
    * @param destination A model element instance aquired through a action taken
    *                    taken on a row of the matrix.
    * @return true if the test succeeds, false if it fails
    */
    boolean checkResult_exists(NonRootModelElement source, NonRootModelElement destination) {
        for(String actual : actualProposals) {
        	// make sure every possibility is present
        	for(String possibility : getPossibilities(getName())) {
	        	if(actual.equals(possibility)) {
	        		return true;
	        	}
        	}
        }
        return false;
    }


}
